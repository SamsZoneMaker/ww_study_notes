# SerDes知识

SerDes是Serializer/Deserializer的缩写，即串行器和解串器，顾名思义是一种将并行数据转换成串行数据发送，将接收的串行数据转换成并行数据的”器件“。

## [并行数据]

并行数据是指通过多条信号线**同时**传输多位数据。每条信号线负责传输一位数据，所有信号线上的数据在**同一时钟周期**内到达接收端。



### **特点**

* 并行传输：多条信号线同时工作（如 8 条、16 条或更多）。

* 高传输速率（短距离时）：因为每次传输的数据位数较多，理论上传输速率更高。

* 适合短距离传输：当距离较短时，信号同步容易，性能较好。



### 优点

* 数据传输速度快（因为多位数据同时传输）。

* 在短距离内，硬件设计较简单。



### 缺点

* 信号同步问题：多条信号线上的数据需要保持时钟同步，距离越长，信号同步难度越大。

- 布线复杂：需要多条信号线，增加布线和电路设计复杂度。

- 高成本：线缆和连接器成本较高。



### 应用场景

- 短距离、高速数据传输场景，如 CPU 内部总线（比如 32 位或 64 位并行总线）。

- 内存总线（如 DDR SDRAM 和处理器之间的通信）。



## [串行数据]

串行数据是指通过**单条信号线**按顺序**逐位**传输数据。发送端将数据从并行格式转为串行格式传输，接收端再将串行数据转回并行格式。



### 特点

逐位传输：一条信号线上一次只能传输 1 位数据。

传输速度高（长距离时）：由于减少了信号线数量和同步问题，串行传输在长距离时更稳定。

信号线简单：只需要一条数据线（有时加上时钟线）。



### 优点

长距离传输能力强：减少了信号线数量，降低了同步误差的概率。

布线简单：只需要一条数据线，电路和连接器设计更简单。

低成本：线缆和接口硬件更便宜。



### 缺点

数据传输速度可能受限于单线的速率，如需提高速率需要通过提高时钟频率补偿。



### 应用场景

长距离数据传输，如 USB、HDMI、SATA、以太网、PCIe。

高速串行通信协议（如 SPI、I2C、UART）。



## Comparison

| **特性**         | **并行数据传输**                   | **串行数据传输**                    |
| ---------------- | ---------------------------------- | ----------------------------------- |
| **传输方式**     | 多条信号线同时传输多位数据         | 单条信号线逐位传输数据              |
| **硬件复杂度**   | 高（需要多条信号线和同步机制）     | 低（信号线少，设计简单）            |
| **成本**         | 高（多条信号线和连接器）           | 低（少量信号线）                    |
| **信号同步问题** | 存在（需要确保多条信号线的同步性） | 基本没有（单线逐位传输）            |
| **传输距离**     | 适合短距离（信号同步容易）         | 适合长距离（信号干扰和同步问题少）  |
| **传输速率**     | 在短距离时传输速率高               | 在长距离时传输速率高                |
| **典型应用**     | CPU 总线、内存总线、打印机并口     | USB、HDMI、以太网、串口通信（UART） |
| **选择**         | 短距离传输（芯片内部、板内通信）   | 长距离传输（设备间通信）            |





## **SerDes 芯片的架构介绍**

SerDes（Serializer/Deserializer）是高速数据通信中的核心技术，其主要目的是在不同设备或芯片之间实现高速、长距离的数据传输。SerDes芯片架构的设计非常关键，决定了数据传输的性能、功耗和可靠性。

### **概述**

SerDes芯片架构主要由两部分组成：

* **Serializer（串行器）：**
  * 负责将并行数据转换为串行数据流。

  * 主要用于减少传输通道的数量，从而降低硬件成本和复杂性。

* **Deserializer（解串器）：**

  - 负责将接收到的串行数据流还原为并行数据。
  - 主要用于支持下游设备或芯片的进一步处理。



**SerDes架构的目标是：**

- 高数据速率传输：支持多Gbps甚至Tbps的数据传输速率。
- 低功耗：优化功耗以适应现代通信和计算需求。
- 低误码率（BER）：保证传输的准确性和稳定性。



### **主要工作**

1.   **高速数据传输**

     - 在设备（如CPU、GPU、存储设备、通信设备）之间传输数据。
     - 应用于PCIe、以太网、USB、HDMI等协议中。

2.   **信号完整性与误码控制**
     - 在高速传输中，信号容易受到噪声、串扰和信号衰减的影响。SerDes通过架构设计，提升信号完整性，降低误码率。

3.   **节约硬件资源**

     - 通过串行化技术减少传输所需的物理通道数，降低成本。
     - 在布线复杂的高速PCB设计中，SerDes尤为重要。

4.   **支持多种通信协议**
     - SerDes芯片通常需要兼容不同的通信协议，比如PCIe、SATA、以太网、DisplayPort等。

5.   **待补充......**



### **Arch实现模块**

1. **串行器部分**（Serializer）

- 工作原理：
  - 接收来自上游设备的多路并行数据。
  - 将这些数据通过多路复用器（Multiplexer, MUX）合并成一条高速串行数据流。
- 关键技术：
  - 时钟多路复用：利用高频时钟将低速并行数据编码到高速串行通道中。
  - 编码技术：如8b/10b或64b/66b编码，确保DC平衡和时钟恢复。

2. **解串器部分（Deserializer）**

- 工作原理：
  - 接收来自串行通道的高速数据流。
  - 通过多路分解器（Demultiplexer, DEMUX）将串行数据恢复为并行数据。
- 关键技术：
  - 时钟数据恢复（Clock Data Recovery, CDR）
    - 从接收到的串行数据中提取嵌入的时钟信号。
  - 均衡器
    - 补偿信号在传输过程中的衰减，恢复原始波形。
    - 包括前馈均衡（FFE）、决策反馈均衡（DFE）等。

3. **时钟管理模块**

- 锁相环（Phase-Locked Loop, PLL）

  * 生成高精度的时钟信号，为串行化和解串化提供稳定的频率。

- 时钟恢复模块

  * 在接收端从数据流中提取时钟信号，保持发送端和接收端的同步。

  4. **信号调节与均衡模块**

- 前馈均衡器（FFE）
  - 在发送端用于预先补偿信号失真。
- 决策反馈均衡器（DFE）
  - 在接收端实时校正信号中的噪声和失真。

  5. **接口与协议适配**

- SerDes通常集成协议栈，以支持各种行业标准协议（如以太网、PCIe等）。





## 技术概览



常用的FPGA、DSP中经常都会集成到SerDes技术，其本质就是并串、串并转换器。

本质的目的是提高传输速度，原则上多加几条线增加芯片间的管脚互联可以实现，但是这种方式的上限极低。随着芯片的小型化，加线即等于加引脚（物理接口），小型化的芯片不可能再加引脚，所以到了后期的发展是不现实的。

SerDes可以减少信号传输所需的信道和引脚的数目，从而减少传输线之间的干扰，增加背板传输距离。原本需要几条线传输的数据，要挤到一起去传输。为了提高速度，信号的完整性和时钟基数就成了SerDes要解决的首要问题。（给信号的抖动非常小）

To be solve: 时钟扭曲、信号衰减、线路噪声 etc,.

平时常见的通信协议，例如PCIE, nvlink, SATA, usb等等很多都是基于SerDes的协议,因此SerDes其实更接近于物理层(PHY层), 是一个[PHY层器件](###PHY层器件：)。

**主要尝试解决的问题：**

1. 传输线对信号有损耗，而TL对低频和高频的损耗是不一样的，要求发送端可以发送出可以抗损耗的数据
2. 接收端要如何恢复损耗后的数据？
3. 接收端应该如何找到信号的起始点，从而找到更佳的采样点？
4. 不同速率下如何调整时钟的信号
5. to be updated



### SerDes的三大模块：

Tx（for transmit）、Rx（for receive）、[PLL（锁相环）](### 锁相环)



Tx: 并行转串行

Rx: 串行解串转并行

PLL： PLL通过相位锁定的方法锁定时钟，有分频和倍频的功能



### Tx：

PCS层：

**Fifo:** (First in first out)，允许在发送之前存储传输的数据。解决跨时钟域转换的问题

**Encoder and Scrambler:** 用于加编码和加扰码，用8b/10b的编码方法防止数据产生连续的0和1。（数据在长时间没有跳动的情况下，采样的时钟会发生漂移）

![Tx_block](figures/Tx_block.png)

PMA层：

**[Equalizer（均衡器）](# Equalizer 均衡器)：**

- 目的：补偿信道对信号的损伤，消除码间干扰

不同频率的信号，其衰减是不一样的，不一致的衰减的导致了码间干扰ISI。信道本身类似于lowpass filter，对高频信号更容易有损伤。所以发送端的eq可以设计成类似的highpass filter，从而进行频率补偿。

**发射（驱动器）：**

把序列化的信号转化成差分信号进行传输（抗干扰），n、p都发射信号



### Rx:

结构与Tx端类似，作用也差不多，多了一个弹性fifo

![rx_block](figures/rx_block.png)



PMA：

**CDR**

CDR (Clock data recover) 时钟恢复期，这是SerDes中的一大关键组成部分.

<img src="/figures/cdr.png" alt="cdr" style="zoom:50%;" />

SerDes和一般传输不一样的地方在于，SerDes没有单独的时钟信号，时钟信号并入数据信号一起传输，好处在于减去了时钟线，不会有其他通信常遇到的时钟边缘和数据中心不对齐的现象（自同步技术）。

简述CDR的基础原理：当数据信号通过CDR的时候，会捕捉数据边沿跳变的一个频率，从而在信号中恢复出一个时钟。 这也呼应了为什么信号不能长时间不跳动，因为会导致cdr产生漂移。其中可以用锁相环或者相位差值器来恢复时钟，再用此时钟采样输入的数据，达到时钟和回复的数据同步的结果。





### PHY层器件：

**物理层**（Physical Layer）是[计算机网络](https://zh.wikipedia.org/wiki/计算机网络)  [OSI模型](https://zh.wikipedia.org/wiki/OSI模型)中最低的一层，也是最基本的一层。简单的说，网络的物理层面确保原始的数据可在各种物理媒体上传输。物理层器件PHY(Physical Layer Interface Devices)是将各网元连接到物理介质上的关键部件。负责完成互连参考模型(OSI)第1层中的功能，即为链路层实体之间进行bit传输提供物理连接所需的机械、电气、光电转换和规程手段。实现物理层比特bit流的透明传输等。

<img src="./figures/OSI_7层模型.png" alt="OSI_7层模型" style="zoom: 67%;" />

<img src="./figures/PHY层结构.png" alt="物理层结构" style="zoom:67%;" />

如图，上图是OSI的七层模型，下图是物理层的结构。物理层包括四个功能层和两个层接口，四个功能层为：物理编码子层、物理介质连接子层、物理介质相关子层和自动协商子层；两个层接口为物理介质无关层接口（MII）和物理介质相关层接口（MDI），在MII的上层是逻辑数据链路层（DLL），而MDI的下层则直接与传输介质相连，以太网物理层PHY芯片实现的功能就是上面所提到的四层和两个接口的功能。



### PLL锁相环



### Equalizer 均衡器

<img src="figures/why_Equalizer" alt="why_Equalizer" style="zoom:67%;" />

这个图展示的是在不同传输速率（2 Gbps, 8 Gbps, 32 Gbps）下信号经过通道（channel）后的波形对比，以及原始发送信号（Tx）波形。横轴是时间（单位为 UI，Unit Interval，单位间隔），纵轴是电压（V）。

> [!NOTE]
>
> UI:
>
> UI 是一个 bit 的时间长度，比如在 2 Gbps 下，UI = 0.5 ns；
>
> 32 Gbps 下，UI = 1 / 32 G = 31.25 ps；
>
> 所以，越高的数据速率，单位时间内要表示的比特越多，系统对 **时间精度与波形完整性要求越高**。

**蓝色虚线（Tx）**：

- 表示原始发送信号，理想方波。
- 没有经过信道的失真影响。

**橙色（2 Gbps）、绿色（8 Gbps）、紫色（32 Gbps）**：

- 表示在不同数据速率下信号经过通道后的波形。
- 经通道后的波形出现了“**信号幅度下降**”、“**边沿变缓**”和“**尾巴拖尾**”现象。
- 随着速率的提升，信号的失真加重，波形变得越来越模糊和低平。



#### 图中结论：

**速率越高，信号退化越严重**：

- 2 Gbps 时基本还可以跟踪原始波形；
- 8 Gbps 时已经出现明显衰减；
- 32 Gbps 时波形幅度极低，失真严重。

**信道具有频率响应**：

- 高频成分（比如快速上升/下降沿）在通道中会被严重衰减；
- 高频分量的损失会使得信号边缘变缓、导致信号展宽跨越不止一个UI；
- 因此高速信号更难维持其原始形状。

**为什么需要均衡器？**

影响信号的不是衰减本身，而是信道的衰减随频率发生变化，高低频信号的衰减导致码间干扰ISI；所以需要解决的并不是信号衰减，而是高低频信号衰减不一致，有衰减差的问题。

均衡器（如FFE、DFE 或 CTLE）就是为了补偿这种频率相关的衰减，恢复接收到的失真信号，尽可能还原成原始的 Tx 波形。

尤其在高速信号（比如 32 Gbps）中均衡器的作用至关重要，否则接收端无法正确判断数据。



#### 信号失真的原因：

- 带宽限制：

  高频成分被抑制，导致信号的上升沿/下降沿变缓，方波变“钝”。

- [ISI（码间干扰）](# ISI 码间干扰)

  由于前一个bit的尾巴影响到后一个bit，造成码与码之间互相干扰。

- 反射与多路径

  接头或阻抗不匹配时会产生反射，造成波形畸变。



#### 常见的均衡器类型：

1. CTLE（Continuous-Time Linear Equalizer - 连续时间线性均衡）

   是一种模拟均衡器

   通过减小低频信号来补偿高低频之间的衰减差，通常配合运放使用

   它在接收端对高频信号进行放大，抵消通道对高频的衰减。

   缺点：会放大高频噪声。

2. FFE（Feed-Forward Equalizer）

   数字均衡器，常用于发送端。

   通过前向加权多个比特的数据，对当前比特进行调节。

   类似 FIR 滤波器，有多个 tap（抽头）。

3. DFE（Decision Feedback Equalizer）

   用于接收端。

   它通过前面已经判决过的数据反馈来消除 ISI。

   只对已知的干扰做补偿，效果好于 FFE，但更复杂。





### ISI 码间干扰
